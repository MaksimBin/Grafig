<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Ротационный график</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:system-ui,sans-serif; background:#0f1216; color:#e7edf6; }
    .wrap { max-width:960px; margin:20px auto; padding:0 16px; }
    h1 { font-size:24px; margin:16px 0; }
    .panel { background:#151a21; border:1px solid #222a33; border-radius:12px; padding:16px; }
    label { font-size:14px; color:#a9b4c4; display:block; margin-bottom:4px; }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #222a33; background:#10151c; color:#e7edf6; font-size:15px; }
    textarea { min-height:60px; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button { flex:1; min-height:44px; padding:10px; border-radius:10px; border:1px solid #222a33; background:#18202a; color:#e7edf6; font-size:15px; }
    .primary { background:linear-gradient(180deg,#2a7fff,#6bd1ff); color:#0a0e13; font-weight:600; }
    .card { background:#0f141b; border:1px solid #222a33; border-radius:10px; padding:10px; margin-top:12px; }

    .schedule-block {
      background:#ffe066;
      color:#0f1216;
      padding:6px 10px;
      border-radius:8px;
      margin:4px 4px 4px 0;
      font-size:14px;
      display:inline-block;
      cursor:pointer;
    }

    @media(max-width:600px){
      h1{font-size:20px;}
      input,textarea,button{font-size:16px;}
      .actions{flex-direction:column;}
    }

    /* Попап */
    .popup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9); /* чёрный фон */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .popup-content {
      position: relative;
      background: #000;
      padding: 20px;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }
    .popup-content h2 {
      color: #fff;
      margin-bottom: 12px;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Часовой График</h1>
    <div class="panel">
      <label>Список людей (через запятую)</label>
      <textarea id="peopleInput">Анна, Богдан, София, Максим</textarea>
      <label>Начало графика</label>
      <input id="startAtInput" type="datetime-local" />
      <label>Длительность смены (часы)</label>
      <input id="shiftHoursInput" type="number" value="3" />
      <label>Пауза между сменами (мин)</label>
      <input id="gapMinutesInput" type="number" value="0" />
      <label>На сколько дней строить график</label>
      <input id="daysInput" type="number" value="30" />
      <div class="actions">
        <button class="primary" id="buildBtn">Собрать расписание</button>
        <button id="nowBtn">Кто сейчас?</button>
      </div>
    </div>

    <div class="card"><h3>Текущий статус</h3><div id="currentStatus">—</div></div>
    <div class="card">
      <h3>Расписание по людям</h3>
      <div id="scheduleText">—</div>
    </div>
  </div>

  <!-- Попап -->
  <div id="popup" class="popup" aria-modal="true" role="dialog">
    <div class="popup-content">
      <button class="close-btn" id="popupClose">✖</button>
      <h2 id="popupTitle"></h2>
      <div id="popupBody"></div>
    </div>
  </div>

  <script>
    function parsePeople(text){ return text.split(',').map(s=>s.trim()).filter(Boolean); }
    function fmt(dt){
      const p=n=>String(n).padStart(2,'0');
      const days=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];
      return `${days[dt.getDay()]} ${p(dt.getHours())}:${p(dt.getMinutes())}`;
    }
    function toLocalDateTimeValue(d=new Date()){
      const pad=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function generateRotationSchedule(people,startAt,shiftHours,gapMinutes=0,days=30){
      if(!people.length) throw new Error("Список людей пуст");
      const schedule=[],shiftMs=shiftHours*3600000,gapMs=gapMinutes*60000,totalMs=days*24*3600000;
      let cursor=new Date(startAt),elapsed=0,i=0;
      while(elapsed<totalMs){
        const person=people[i%people.length];
        const start=new Date(cursor),end=new Date(start.getTime()+shiftMs);
        schedule.push({person,start,end});
        cursor=new Date(end.getTime()+gapMs);
        elapsed=cursor.getTime()-startAt.getTime();
        i++;
      }
      return schedule;
    }
    function whoIsOnShift(people,startAt,shiftHours,gapMinutes=0,at=new Date()){
      const shiftMs=shiftHours*3600000,gapMs=gapMinutes*60000,blockMs=shiftMs+gapMs,diffMs=at.getTime()-startAt.getTime();
      if(diffMs<0) return {person:people[0],start:startAt,end:new Date(startAt.getTime()+shiftMs)};
      const blocks=Math.floor(diffMs/blockMs),person=people[blocks%people.length];
      const start=new Date(startAt.getTime()+blocks*blockMs),end=new Date(start.getTime()+shiftMs);
      if(gapMs>0 && at>=end && at<new Date(end.getTime()+gapMs)) return {person:null,start,end};
      return {person,start,end};
    }

    const peopleInput=document.getElementById('peopleInput'),
          startAtInput=document.getElementById('startAtInput'),
          shiftHoursInput=document.getElementById('shiftHoursInput'),
          gapMinutesInput=document.getElementById('gapMinutesInput'),
          daysInput=document.getElementById('daysInput'),
          buildBtn=document.getElementById('buildBtn'),
          nowBtn=document.getElementById('nowBtn'),
          scheduleText=document.getElementById('scheduleText'),
          currentStatus=document.getElementById('currentStatus'),
          popup=document.getElementById('popup'),
          popupTitle=document.getElementById('popupTitle'),
          popupBody=document.getElementById('popupBody'),
          popupClose=document.getElementById('popupClose');

    startAtInput.value=toLocalDateTimeValue(new Date());

    let schedule=[], grouped={};

    function build(){
      try{
        const people=parsePeople(peopleInput.value),
              startAt=new Date(startAtInput.value),
              shiftHours=Number(shiftHoursInput.value),
              gapMinutes=Number(gapMinutesInput.value),
              days=Number(daysInput.value);

        schedule=generateRotationSchedule(people,startAt,shiftHours,gapMinutes,days);

        grouped={};
        for(const s of schedule){
          if(!grouped[s.person]) grouped[s.person]=[];
          grouped[s.person].push(`${fmt(s.start)} → ${fmt(s.end)}`);
        }

        let html="";
        for(const person of people){
          if(grouped[person]){
            html+=`<div><b>${person}:</b><br>`;
            for(const shift of grouped[person]){
              html+=`<span class="schedule-block" data-person="${person}">${shift}</span> `;
            }
            html+="</div><br>";
          }
        }
        scheduleText.innerHTML=html;

        renderCurrentStatus(people,startAt,shiftHours,gapMinutes);
      }catch(e){
        alert(e.message);
      }
    }

    function renderCurrentStatus(people,startAt,shiftHours,gapMinutes){
      const info=whoIsOnShift(people,startAt,shiftHours,gapMinutes,new Date());
      currentStatus.innerHTML=info.person
        ? `<b>${info.person}</b> с ${fmt(info.start)} до ${fmt(info.end)}`
        : `Сейчас пауза`;
    }

    function openPopup(person){
      popupTitle.textContent = person;
      const shifts = grouped[person] || [];
      popupBody.innerHTML = shifts.length
        ? shifts.map(s=>`<div class="schedule-block">${s}</div>`).join('')
        : '<div class="schedule-block">Нет смен</div>';
      popup.style.display='flex';
    }

    function closePopup(){
      popup.style.display='none';
    }

    // Делегирование кликов по расписанию
    scheduleText.addEventListener('click',(e)=>{
      const el=e.target;
      if(el.classList.contains('schedule-block')){
        const person = el.getAttribute('data-person');
        if(person) openPopup(person);
      }
    });

    // Закрытие попапа по кнопке, фону и Esc
    popupClose.addEventListener('click', closePopup);
    popup.addEventListener('click',(e)=>{
      if(e.target === popup) closePopup();
    });
    document.addEventListener('keydown',(e)=>{
      if(e.key === 'Escape' && popup.style.display==='flex') closePopup();
    });

    buildBtn.addEventListener('click', build);

    nowBtn.addEventListener('click', ()=>{
      const people=parsePeople(peopleInput.value);
      renderCurrentStatus(
        people,
        new Date(startAtInput.value),
        Number(shiftHoursInput.value),
        Number(gapMinutesInput.value)
      );
    });

    // Стартовая сборка
    build();
  </script>
</body>
</html>